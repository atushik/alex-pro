<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>AlexLivraison Pro</title>
<meta name="theme-color" content="#6b23ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="logo-pro.jpg">
<link rel="manifest" href="./manifest-pro.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  :root{--primary:#6b23ff;--accent:#00e676;--bg:#f2f2f7;--text:#1d1d1f;--shadow:0 8px 30px rgba(0,0,0,0.12);}
  * {box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  body {font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:var(--bg); margin:0; padding:0; color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column;}
  #map-layer {position:absolute; top:0; left:0; width:100%; height:100%; z-index:0;}
  .map-logo {position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; border-radius: 50%; border: 3px solid #fff; box-shadow: var(--shadow); z-index: 20; object-fit: cover; animation: floatLogo 4s ease-in-out infinite;}
  @keyframes floatLogo { 0%,100%{transform:translate(-50%, 0);} 50%{transform:translate(-50%, -5px);} }
  .top-bar {position: absolute; top: 0; left: 0; width: 100%; z-index: 10; padding: 15px 15px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none;}
  .status-pill {pointer-events: auto; background: #fff; padding: 10px 15px; border-radius: 50px; display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.9em; box-shadow: 0 4px 20px rgba(0,0,0,0.15); cursor: pointer; transition: 0.3s;}
  .status-pill:active { transform: scale(0.95); }
  .dot {width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent);}
  .dot.off {background: #ff4d4d; box-shadow: 0 0 8px #ff4d4d;}
  .settings-btn {pointer-events: auto; background: #fff; padding: 10px 15px; border-radius: 50px; display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 0.9em; box-shadow: 0 4px 20px rgba(0,0,0,0.15); cursor: pointer; transition: 0.3s; color: #333;}
  .settings-btn:active { transform: scale(0.95); }
  .orders-carousel {position: absolute; bottom: 90px; left: 0; right: 0; z-index: 10; display: flex; gap: 10px; overflow-x: auto; padding: 0 15px; scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; padding-bottom: 5px;}
  .orders-carousel::-webkit-scrollbar {display: none;}
  .order-card {min-width: 240px; max-width: 260px; background: #fff; border-radius: 18px; padding: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); scroll-snap-align: center; border-left: 5px solid var(--primary); display: flex; flex-direction: column; justify-content: space-between; animation: popIn 0.3s ease-out; height: auto; min-height: 140px;}
  @keyframes popIn { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }
  .order-head {display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;}
  .shop-name {font-weight: 700; font-size: 0.9em; color: #333; display:flex; align-items:center; gap:5px;}
  .order-price {background: #6b23ff; color: #fff; padding: 4px 8px; border-radius: 8px; font-weight: 800; font-size: 0.85em;}
  .big-info {display: flex; flex-direction: column; align-items: flex-start; justify-content: center; padding: 8px; background: #f8f9fa; border-radius: 10px; margin-bottom: 8px; flex:1; width:100%;}
  .info-tag {font-weight: 600; font-size: 0.8em; color: #555; display:flex; align-items:flex-start; gap:5px; white-space: normal; word-break: break-word; text-align: left; width: 100%; line-height: 1.3; margin-bottom: 4px;}
  .info-tag:last-child {margin-bottom: 0;}
  .arrow-down { font-size: 0.8em; color: #ccc; margin: 2px 0 2px 22px; line-height: 1; }
  .btn-accept {width: 100%; padding: 10px; background: #6b23ff; color: #fff; border: none; border-radius: 10px; font-weight: 800; font-size: 0.9em; cursor: pointer; box-shadow: 0 3px 10px rgba(107,35,255,0.3); text-transform:uppercase;}
  .btn-accept:active { transform: scale(0.98); }
  .empty-state {position: absolute; bottom: 140px; width: 90%; left: 5%; text-align: center; color: #666; font-weight: 600; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); backdrop-filter: blur(10px);}
  .nav-bar {position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.98); backdrop-filter:blur(20px); border-top:1px solid rgba(0,0,0,0.05); display:flex; justify-content:space-around; padding:10px 0; padding-bottom:30px; z-index:50; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);}
  .nav-item {display:flex; flex-direction:column; align-items:center; gap:5px; color:#aaa; font-size:0.75em; font-weight: 700; cursor:pointer; width: 20%; transition: 0.3s;}
  .nav-item.active { color:var(--primary); transform: translateY(-4px); }
  .nav-item.active .nav-icon { color: var(--primary); }
  .nav-icon { font-size:1.7em; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
  .full-page {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; z-index: 100; display: none; flex-direction: column; overflow-y: auto;}
  .page-header {background: #fff; padding: 15px 20px; padding-top: 50px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 101;}
  .btn-back-page { width: 40px; height: 40px; border-radius: 50%; border: none; background: #f5f5f5; font-size: 1.8em; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary);}
  .page-title { font-size: 1.3em; font-weight: 800; flex: 1; color: #1c1c1e; }
  .page-content { padding: 20px; padding-bottom: 100px; }
  .emoji-anim { display: inline-block; animation: stickerFloat 3s ease-in-out infinite; }
  @keyframes stickerFloat { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(5deg); } 100% { transform: translateY(0) rotate(0deg); } }
  @keyframes markerRide { 0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); } 25% { transform: translate(-50%, -55%) scale(1.1) rotate(-3deg); } 50% { transform: translate(-50%, -50%) scale(1) rotate(0deg); } 75% { transform: translate(-50%, -55%) scale(1.1) rotate(3deg); } 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); } }
  .marker-anim { display: flex; align-items: center; justify-content: center; font-size: 32px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: markerRide 1.2s infinite linear; filter: drop-shadow(0 5px 8px rgba(0,0,0,0.3)); }
  .leaflet-div-icon { background: transparent; border: none; }
  .profile-header {background: #fff; padding: 30px 20px; text-align: center; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px;}
  .profile-pic {width: 90px; height: 90px; border-radius: 50%; background: #f0f2f5; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 3em; border: 3px solid var(--primary); overflow: hidden; position: relative;}
  .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
  .menu-list { background: #fff; border-radius: 20px; overflow: hidden; box-shadow: var(--shadow); }
  .menu-item {padding: 18px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 600; font-size: 1em; color: #333;}
  .menu-item:last-child { border-bottom: none; }
  .doc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
  .doc-card {background: #fff; padding: 15px; border-radius: 16px; text-align: center; box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative;}
  .doc-card-btn {position: absolute; top: 5px; right: 5px; background: #eee; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;}
  .btn-save {width: 100%; padding: 16px; background: #007bff; color: #fff; border: none; border-radius: 50px; font-weight: 800; font-size: 1.1em; margin-top: 20px; cursor: pointer; box-shadow: 0 8px 20px rgba(0,123,255,0.3);}
  .range-box { background: #fff; padding: 25px; border-radius: 24px; text-align: center; margin-top: 20px; box-shadow: var(--shadow);}
  .map-preview-box {height: 180px; background: #eee; border-radius: 16px; margin-bottom: 20px; overflow: hidden; position: relative; border: 2px solid #fff;}
  .active-order-box {background: #fff; padding: 20px; border-radius: 20px; box-shadow: var(--shadow);}
  .step-card {border-left: 3px solid #ddd; padding-left: 20px; margin-bottom: 25px; position: relative;}
  .step-card.active {border-left-color: var(--primary);}
  .step-card::before {content: ''; position: absolute; left: -8px; top: 0; width: 13px; height: 13px; border-radius: 50%; background: #ccc; border: 2px solid #fff;}
  .step-card.active::before {background: var(--primary); box-shadow: 0 0 0 3px rgba(107,35,255,0.2);}
  .btn-action {width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; color: #fff;}
  .btn-pickup { background: #ff9800; box-shadow: 0 4px 15px rgba(255,152,0,0.3); }
  .btn-deliver { background: #00c853; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
</style>
</head>
<body>

<div id="map-layer"></div>
<img src="logo-pro.jpg" class="map-logo">

<div class="top-bar">
    <div class="status-pill" onclick="toggleStatus()">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">En ligne</span>
    </div>
    <div class="settings-btn" onclick="openPage('settings')">
        <span class="emoji-anim">‚öôÔ∏è</span> R√©glages
    </div>
</div>

<div id="orders-container" class="orders-carousel">
    <div class="empty-state">
        <span class="emoji-anim" style="font-size:2em">üì°</span><br>
        Recherche de courses...
    </div>
</div>

<div class="nav-bar">
  <div class="nav-item active" onclick="closeAllPages()">
    <div class="nav-icon emoji-anim">‚ö°</div>
    <div>Accueil</div>
  </div>
  <div class="nav-item" onclick="openPage('encours')">
    <div class="nav-icon emoji-anim">üéí</div>
    <div>En cours</div>
  </div>
  <div class="nav-item" onclick="openPage('wallet')">
    <div class="nav-icon emoji-anim">üí∞</div>
    <div>Gains</div>
  </div>
  <div class="nav-item" onclick="openPage('aide')">
    <div class="nav-icon emoji-anim">üí¨</div>
    <div>Aide</div>
  </div>
  <div class="nav-item" onclick="openPage('profile')">
    <div class="nav-icon emoji-anim">üë§</div>
    <div>Compte</div>
  </div>
</div>

<div id="page-settings" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">R√©glages</div>
    </div>
    <div class="page-content">
        <div class="menu-list">
             <div class="menu-item" onclick="openRadiusSettings()">
                <span><span class="emoji-anim">üó∫Ô∏è</span> Type de carte (Distance)</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item">
                <span><span class="emoji-anim">üîî</span> Notifications</span>
                <input type="checkbox" checked>
            </div>
        </div>
        
        <div id="radius-box" class="range-box" style="display:none">
             <h3>Rayon d'action</h3>
             <div class="map-preview-box" id="settingMap"></div>
             <input type="range" min="1" max="50" value="15" oninput="updateRadius(this.value)" style="width:100%">
             <h2 style="color:#6b23ff;margin:10px 0"><span id="distVal">15</span> km</h2>
             <button class="btn-save" onclick="document.getElementById('radius-box').style.display='none'">Valider</button>
        </div>
    </div>
</div>

<div id="page-profile" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Mon Compte</div>
    </div>
    <div class="page-content">
        <div class="profile-header">
            <div class="profile-pic" onclick="document.getElementById('avatarInput').click()">
                <span id="avatarEmoji" class="emoji-anim">üì∏</span>
                <img id="avatarImg" src="" style="display:none">
            </div>
            <input type="file" id="avatarInput" hidden accept="image/*" onchange="previewAvatar(this)">
            <h2 id="profileName" style="margin:5px 0">Chargement...</h2>
            <p style="color:#888;margin:0">Coursier Certifi√©</p>
        </div>

        <div class="menu-list">
            <div class="menu-item" onclick="openPage('documents')">
                <span><span class="emoji-anim">üìÇ</span> Mes documents</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item" onclick="openPage('transport')">
                <span><span class="emoji-anim">üõµ</span> Mon v√©hicule</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item" style="color:red" onclick="logout()">
                <span><span class="emoji-anim">üî¥</span> D√©connexion</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
        </div>
    </div>
</div>

<div id="page-transport" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="openPage('profile')">‚Äπ</button>
        <div class="page-title">Mon V√©hicule</div>
    </div>
    <div class="page-content">
        <div class="menu-list" id="vehicleList"></div>
    </div>
</div>

<div id="page-documents" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="openPage('profile')">‚Äπ</button>
        <div class="page-title">Gestion Documents</div>
    </div>
    <div class="page-content">
        <h3 style="margin-left:10px">Mes pi√®ces justificatives</h3>
        <div class="doc-grid">
            <div class="doc-card">
                <div class="doc-card-btn" onclick="alert('Supprimer ?')">üóëÔ∏è</div>
                <div class="emoji-anim" style="font-size:2em">üÜî</div>
                <div style="font-weight:bold;font-size:0.9em">Identit√©</div>
                <span style="background:#e8f5e9;color:#2e7d32;padding:2px 6px;border-radius:4px;font-size:0.7em">Valid√©</span>
            </div>
            <div class="doc-card" onclick="alert('Modifier le RIB')">
                <div class="doc-card-btn">‚úèÔ∏è</div>
                <div class="emoji-anim" style="font-size:2em">üè¶</div>
                <div style="font-weight:bold;font-size:0.9em">RIB / IBAN</div>
                <span style="background:#fff3e0;color:#ef6c00;padding:2px 6px;border-radius:4px;font-size:0.7em">√Ä jour</span>
            </div>
            <div class="doc-card">
                 <div class="doc-card-btn">üëÅÔ∏è</div>
                <div class="emoji-anim" style="font-size:2em">üìÑ</div>
                <div style="font-weight:bold;font-size:0.9em">Contrat</div>
                <span style="background:#e8f5e9;color:#2e7d32;padding:2px 6px;border-radius:4px;font-size:0.7em">Sign√©</span>
            </div>
             <div class="doc-card" style="border:2px dashed #ccc;background:transparent" onclick="alert('Ajouter un document')">
                <div style="font-size:2em">‚ûï</div>
                <div style="font-weight:bold;color:#666">Ajouter</div>
            </div>
        </div>
    </div>
</div>

<div id="page-aide" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Aide</div>
    </div>
    <div class="page-content">
        <div class="menu-list">
            <div class="menu-item" onclick="location.href='https://wa.me/33677171188'">
                <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">üí¨</span> Support WhatsApp</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item" onclick="location.href='tel:+33677171188'">
                <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">üìû</span> Appeler l'assistance</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item">
                <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">‚ùì</span> FAQ</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
        </div>
    </div>
</div>

<div id="page-wallet" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Ma Cagnotte</div>
    </div>
    <div class="page-content">
        <div style="padding:20px">
            <div style="background:linear-gradient(45deg,#ff6b6b,#ee5253);padding:30px;border-radius:20px;color:#fff;text-align:center;box-shadow:0 10px 30px rgba(238,82,83,0.3)">
                <div style="opacity:0.9">Solde disponible</div>
                <div style="font-size:2.5em;font-weight:900;margin:10px 0" id="walletAmount">0,00 ‚Ç¨</div>
            </div>
            <button class="btn-save" style="background:#333;margin-top:20px">üè¶ Retirer mes fonds</button>
        </div>
    </div>
</div>

<div id="page-encours" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Livraison en cours</div>
    </div>
    <div class="page-content" id="activeOrderContent">
         <div style="padding:40px;text-align:center">
            <span class="emoji-anim" style="font-size:5em;display:block;margin-bottom:20px">ü§∑‚Äç‚ôÇÔ∏è</span>
            <h3 style="color:#333">Aucune livraison</h3>
        </div>
    </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

if(!localStorage.getItem('alex_courier_logged')) window.location.href='index.html';

let map, marker, isOnline=true, settingMap, courierLat=43.1242, courierLon=5.928, deliveryRadius=15, currentOrderId=null;
let currentVehicleIcon = 'üö¥';

const VEHICLES = [
    "√Ä pied <span class='emoji-anim'>üö∂</span>", 
    "Trottinette <span class='emoji-anim'>üõ¥</span>", 
    "V√©lo <span class='emoji-anim'>üö≤</span>", 
    "V√©lo √âlectrique <span class='emoji-anim'>‚ö°üö≤</span>",
    "Scooter <span class='emoji-anim'>üõµ</span>", 
    "Scooter √âlectrique <span class='emoji-anim'>‚ö°üõµ</span>", 
    "Voiture <span class='emoji-anim'>üöó</span>", 
    "Voiture √âlectrique <span class='emoji-anim'>‚ö°üöó</span>",
    "Camionnette <span class='emoji-anim'>üöê</span>", 
    "Camionnette √âlec. <span class='emoji-anim'>‚ö°üöê</span>", 
    "Camion <span class='emoji-anim'>üöõ</span>", 
    "Camion √âlectrique <span class='emoji-anim'>‚ö°üöõ</span>"
];

function initMap() {
  map = L.map('map-layer', {zoomControl: false, attributionControl: false}).setView([courierLat, courierLon], 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
  
  const icon = L.divIcon({
      className: 'custom-marker-container',
      html: `<span class="marker-anim">${currentVehicleIcon}</span>`,
      iconSize: [40, 40],
      iconAnchor: [20, 20]
  });
  marker = L.marker([courierLat, courierLon], {icon: icon}).addTo(map);
  
  if(navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
          courierLat = pos.coords.latitude; courierLon = pos.coords.longitude;
          marker.setLatLng([courierLat, courierLon]);
          if(!currentOrderId) map.setView([courierLat, courierLon], 13);
      });
  }
  loadOrders();
  loadVehicleList();
  
  const savedAvatar = localStorage.getItem('alex_avatar');
  if(savedAvatar) {
      document.getElementById('avatarImg').src = savedAvatar;
      document.getElementById('avatarImg').style.display = 'block';
  }
  document.getElementById('profileName').innerText = localStorage.getItem('alex_courier_name') || 'Livreur';
  checkActiveOrder();
}

function loadVehicleList(){
    const list = document.getElementById('vehicleList');
    VEHICLES.forEach(v => {
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.innerHTML = `<span>${v}</span><span class="menu-arrow">‚ö™</span>`;
        div.onclick = () => {
             document.querySelectorAll('#vehicleList .menu-arrow').forEach(e=>e.innerText='‚ö™');
             div.querySelector('.menu-arrow').innerText='‚úÖ';
             
             const parser = new DOMParser();
             const htmlDoc = parser.parseFromString(v, 'text/html');
             const emojiSpan = htmlDoc.querySelector('.emoji-anim');
             if(emojiSpan) {
                currentVehicleIcon = emojiSpan.innerText;
                if(marker && map) {
                     marker.setIcon(L.divIcon({
                        className: 'custom-marker-container',
                        html: `<span class="marker-anim">${currentVehicleIcon}</span>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    }));
                }
             }
             alert('V√©hicule s√©lectionn√© !');
        };
        list.appendChild(div);
    });
}

function toggleStatus() {
    isOnline = !isOnline;
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    if (isOnline) {
        dot.classList.remove('off'); txt.innerText = "En ligne"; 
        loadOrders();
    } else {
        dot.classList.add('off'); txt.innerText = "Hors ligne";
        document.getElementById('orders-container').innerHTML = '<div class="empty-state">Vous √™tes hors ligne</div>';
    }
}

function loadOrders() {
    if(!isOnline) return;
    db.collection('orders').where('status', '==', 'pending').onSnapshot(snap => {
        const container = document.getElementById('orders-container');
        container.innerHTML = '';
        if(snap.empty) {
            container.innerHTML = '<div class="empty-state"><span class="emoji-anim">üì°</span><br>Recherche de courses...</div>';
            return;
        }
        snap.forEach(doc => {
            const o = doc.data();
            const card = document.createElement('div');
            card.className = 'order-card';
            card.innerHTML = `
                <div class="order-head">
                    <div class="shop-name"><span class="emoji-anim">üè™</span> ${o.shopName||'Resto'}</div>
                    <div class="order-price">${o.price} ‚Ç¨</div>
                </div>
                <div class="big-info">
                    <div class="info-tag"><span class="emoji-anim">üìç</span> <span>${o.from}</span></div>
                    <div class="arrow-down">‚¨á</div>
                    <div class="info-tag"><span class="emoji-anim">üèÅ</span> <span>${o.to}</span></div>
                </div>
                <button class="btn-accept" onclick="acceptOrder('${doc.id}')">ACCEPTER</button>
            `;
            container.appendChild(card);
        });
    });
}

function openPage(id) {
    document.querySelectorAll('.full-page').forEach(p => p.style.display = 'none');
    document.getElementById('page-' + id).style.display = 'flex';
}
function closeAllPages() {
    document.querySelectorAll('.full-page').forEach(p => p.style.display = 'none');
}

function openRadiusSettings(){
    const box = document.getElementById('radius-box');
    box.style.display = 'block';
    if(!settingMap) {
        setTimeout(() => {
            settingMap = L.map('settingMap', {zoomControl:false}).setView([courierLat, courierLon], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(settingMap);
            L.circle([courierLat, courierLon], {color: '#6b23ff', radius: deliveryRadius * 1000}).addTo(settingMap);
        }, 200);
    }
}
function updateRadius(val) {
    deliveryRadius = val;
    document.getElementById('distVal').innerText = val;
}

function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarImg').src = e.target.result;
            document.getElementById('avatarImg').style.display = 'block';
            localStorage.setItem('alex_avatar', e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

async function acceptOrder(id) {
    await db.collection('orders').doc(id).update({status: 'accepted', courierId: localStorage.getItem('alex_courier_id')});
    currentOrderId = id;
    checkActiveOrder();
    openPage('encours');
}

function checkActiveOrder() {
    const uid = localStorage.getItem('alex_courier_id');
    db.collection('orders').where('courierId', '==', uid).where('status', 'in', ['accepted', 'picked_up']).onSnapshot(snap => {
        if(!snap.empty) {
            const doc = snap.docs[0];
            renderActiveUI(doc.id, doc.data());
        }
    });
}

function renderActiveUI(id, data){
    const isPicked = data.status === 'picked_up';
    document.getElementById('activeOrderContent').innerHTML = `
        <div class="active-order-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h2 style="margin:0;color:#333">En Cours</h2>
                <div class="emoji-anim" style="font-size:2.5em">${currentVehicleIcon}</div>
            </div>
            <div class="step-card ${!isPicked?'active':''}">
                <div style="font-weight:bold;margin-bottom:5px;display:flex;align-items:center;gap:5px"><span class="emoji-anim">üìç</span> Restaurant</div>
                <div style="color:#666;font-size:0.9em;white-space:normal;word-break:break-word">${data.from}</div>
                ${!isPicked ? `<button class="btn-action btn-pickup" onclick="db.collection('orders').doc('${id}').update({status:'picked_up'})">üì¶ Colis R√©cup√©r√©</button>` : ''}
            </div>
            <div class="step-card ${isPicked?'active':''}">
                <div style="font-weight:bold;margin-bottom:5px;display:flex;align-items:center;gap:5px"><span class="emoji-anim">üèÅ</span> Client</div>
                <div style="color:#666;font-size:0.9em;white-space:normal;word-break:break-word">${data.to}</div>
                ${isPicked ? `<button class="btn-action btn-deliver" onclick="finishOrder('${id}')">‚úÖ Livr√©</button>` : ''}
            </div>
        </div>
    `;
}

function finishOrder(id){
    db.collection('orders').doc(id).update({status:'delivered'});
    const w = parseFloat(localStorage.getItem('alex_wallet')||0) + 5.00;
    localStorage.setItem('alex_wallet', w.toFixed(2));
    document.getElementById('walletAmount').innerText = w.toFixed(2) + " ‚Ç¨";
    alert("Bravo ! Course termin√©e.");
    closeAllPages();
}

function logout() {
    if(confirm("D√©connexion ?")) {
        localStorage.removeItem('alex_courier_logged');
        window.location.href = 'index.html';
    }
}

window.onload = initMap;
</script>
</body>
</html> 
