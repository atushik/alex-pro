<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>AlexLivraison Pro</title>
<meta name="theme-color" content="#052e16">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="logo-pro.jpg">
<link rel="manifest" href="./manifest-pro.json?v=3">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  :root{--primary:#00c853;--dark:#052e16;--glass:rgba(5, 46, 22, 0.9);--text:#ffffff;}
  * {box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body {font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background:var(--dark); margin:0; padding:0; color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column;}
  #map-layer {position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; background:#111;}
  .bg-logos {position:fixed; top:0; left:0; width:100%; height:100%; overflow:hidden; z-index:0; pointer-events:none;}
  .floating-logo {position:absolute; width:60px; height:60px; border-radius:50%; opacity:0.15; animation:floatUp 20s linear infinite; object-fit:cover; filter:grayscale(100%) brightness(200%);}
  .floating-logo:nth-child(1) {left:10%; animation-duration:15s; animation-delay:0s;}
  .floating-logo:nth-child(2) {left:80%; animation-duration:25s; animation-delay:2s;}
  .floating-logo:nth-child(3) {left:40%; animation-duration:18s; animation-delay:5s;}
  .floating-logo:nth-child(4) {left:20%; animation-duration:22s; animation-delay:8s;}
  .floating-logo:nth-child(5) {left:60%; animation-duration:30s; animation-delay:1s;}
  @keyframes floatUp {0%{transform:translateY(110vh) rotate(0deg);} 100%{transform:translateY(-10vh) rotate(360deg);}}
  .leaflet-control-zoom {border:none !important; box-shadow:0 4px 15px rgba(0,0,0,0.5) !important; margin-top: 60px !important; margin-left: 15px !important;}
  .leaflet-bar a {background:rgba(0,50,0,0.9) !important; color:#fff !important; border-bottom:1px solid #333 !important; width:36px !important; height:36px !important; line-height:36px !important; font-size:18px !important; border-radius:8px !important;}
  .leaflet-bar a:first-child {border-bottom-left-radius:0 !important; border-bottom-right-radius:0 !important;}
  .leaflet-bar a:last-child {border-top-left-radius:0 !important; border-top-right-radius:0 !important; border-bottom:none !important;}
  .map-logo {position:absolute; top:15px; left:50%; transform:translateX(-50%); width:60px; height:60px; border-radius:50%; border:3px solid var(--primary); box-shadow:0 8px 30px rgba(0,200,83,0.3); z-index:20; object-fit:cover; animation:floatLogo 4s ease-in-out infinite;}
  @keyframes floatLogo {0%,100%{transform:translate(-50%,0);} 50%{transform:translate(-50%,-5px);}}
  .top-bar {position:absolute; top:0; left:0; width:100%; z-index:10; padding:15px; display:flex; justify-content:space-between; align-items:flex-start; pointer-events:none;}
  .status-pill {pointer-events:auto; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); padding:8px 12px; border-radius:50px; display:flex; align-items:center; gap:8px; font-weight:700; font-size:0.85em; box-shadow:0 4px 20px rgba(0,0,0,0.3); cursor:pointer; border:1px solid rgba(255,255,255,0.15); color:#fff;}
  .dot {width:10px; height:10px; border-radius:50%; background:var(--primary); box-shadow:0 0 10px var(--primary);}
  .dot.off {background:#ff4d4d; box-shadow:0 0 10px #ff4d4d;}
  .settings-btn {pointer-events:auto; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); padding:8px 12px; border-radius:50px; display:flex; align-items:center; gap:6px; font-weight:700; font-size:0.85em; box-shadow:0 4px 20px rgba(0,0,0,0.3); cursor:pointer; color:#fff; border:1px solid rgba(255,255,255,0.15);}
  .orders-carousel {position:absolute; bottom:90px; left:0; right:0; z-index:10; display:flex; gap:10px; overflow-x:auto; padding:0 15px; scroll-snap-type:x mandatory; scroll-behavior:smooth; -webkit-overflow-scrolling:touch; padding-bottom:5px;}
  .orders-carousel::-webkit-scrollbar {display:none;}
  .order-card {min-width:240px; background:rgba(20,20,20,0.95); backdrop-filter:blur(10px); border-radius:16px; padding:10px; box-shadow:0 5px 20px rgba(0,0,0,0.6); scroll-snap-align:center; border:1px solid rgba(255,255,255,0.1); border-left:4px solid var(--primary); display:flex; flex-direction:column; justify-content:space-between; animation:popIn 0.3s ease-out; color:#fff;}
  @keyframes popIn {from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1}}
  .order-head {display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;}
  .shop-name {font-weight:700; font-size:0.9em; color:#fff; display:flex; align-items:center; gap:5px;}
  .order-price {background:var(--primary); color:#000; padding:2px 8px; border-radius:6px; font-weight:800; font-size:0.85em;}
  .big-info {display:flex; flex-direction:column; align-items:flex-start; justify-content:center; padding:6px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:6px; width:100%;}
  .info-tag {font-weight:600; font-size:0.8em; color:#ddd; display:flex; align-items:center; gap:6px; text-align:left; width:100%; line-height:1.2; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .arrow-down {font-size:0.7em; color:var(--primary); margin:0 0 0 20px;}
  .btn-accept {width:100%; padding:8px; background:linear-gradient(135deg,var(--primary), #009624); color:#fff; border:none; border-radius:8px; font-weight:800; font-size:0.9em; cursor:pointer; box-shadow:0 3px 10px rgba(0,200,83,0.3); text-transform:uppercase;}
  .btn-accept:active {transform:scale(0.98);}
  .empty-state {position:absolute; bottom:140px; width:90%; left:5%; text-align:center; color:#fff; font-weight:600; background:rgba(0,0,0,0.8); padding:20px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);}
  .nav-bar {position:fixed; bottom:0; left:0; width:100%; background:rgba(5, 46, 22, 0.98); backdrop-filter:blur(20px); border-top:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-around; padding:8px 0; padding-bottom:25px; z-index:50; box-shadow:0 -5px 20px rgba(0,0,0,0.5);}
  .nav-item {display:flex; flex-direction:column; align-items:center; gap:4px; color:#888; font-size:0.7em; font-weight:700; cursor:pointer; width:20%; transition:0.3s;}
  .nav-item.active {color:var(--primary); transform:translateY(-2px);}
  .nav-icon {font-size:1.5em; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));}
  .full-page {position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #052e16 0%, #004d40 100%); z-index:100; display:none; flex-direction:column; overflow-y:auto;}
  .page-header {background:rgba(5, 46, 22, 0.95); padding:15px 20px; padding-top:50px; display:flex; align-items:center; gap:15px; box-shadow:0 4px 20px rgba(0,0,0,0.3); position:sticky; top:0; z-index:101; border-bottom:1px solid rgba(255,255,255,0.1);}
  .btn-back-page {width:40px; height:40px; border-radius:50%; border:none; background:rgba(255,255,255,0.1); font-size:1.5em; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff;}
  .page-title {font-size:1.3em; font-weight:800; flex:1; color:#fff;}
  .page-content {padding:20px; padding-bottom:100px; position:relative; z-index:2;}
  .emoji-anim {display:inline-block; animation:stickerFloat 3s ease-in-out infinite;}
  @keyframes stickerFloat {0%{transform:translateY(0) rotate(0deg)} 50%{transform:translateY(-5px) rotate(5deg)} 100%{transform:translateY(0) rotate(0deg)}}
  @keyframes markerRide {0%{transform:translate(-50%,-50%) scale(1) rotate(0deg)} 25%{transform:translate(-50%,-55%) scale(1.1) rotate(-3deg)} 50%{transform:translate(-50%,-50%) scale(1) rotate(0deg)} 75%{transform:translate(-50%,-55%) scale(1.1) rotate(3deg)} 100%{transform:translate(-50%,-50%) scale(1) rotate(0deg)}}
  .marker-anim {display:flex; align-items:center; justify-content:center; font-size:36px; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); animation:markerRide 1.2s infinite linear; filter:drop-shadow(0 5px 8px rgba(0,0,0,0.5));}
  .leaflet-div-icon {background:transparent; border:none;}
  .profile-header {background:rgba(255,255,255,0.05); padding:30px 20px; text-align:center; border-radius:25px; border:1px solid rgba(255,255,255,0.1); margin-bottom:20px;}
  .profile-pic {width:100px; height:100px; border-radius:50%; background:rgba(0,0,0,0.3); margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:3em; border:3px solid var(--primary); overflow:hidden; position:relative; box-shadow:0 0 20px rgba(0,200,83,0.2);}
  .profile-pic img {width:100%; height:100%; object-fit:cover;}
  .menu-list {background:rgba(255,255,255,0.05); border-radius:20px; overflow:hidden; border:1px solid rgba(255,255,255,0.1);}
  .menu-item {padding:18px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-weight:600; font-size:1em; color:#fff; transition:0.2s;}
  .menu-item:active {background:rgba(255,255,255,0.1);}
  .menu-item:last-child {border-bottom:none;}
  .doc-grid {display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px;}
  .doc-card {background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; text-align:center; border:1px solid rgba(255,255,255,0.1); display:flex; flex-direction:column; align-items:center; gap:8px; position:relative; color:#fff;}
  .doc-card-btn {position:absolute; top:5px; right:5px; background:rgba(255,255,255,0.2); border-radius:50%; width:25px; height:25px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer;}
  .btn-save {width:100%; padding:16px; background:linear-gradient(135deg,var(--primary),#009624); color:#fff; border:none; border-radius:50px; font-weight:800; font-size:1.1em; margin-top:20px; cursor:pointer; box-shadow:0 8px 20px rgba(0,200,83,0.3);}
  .range-box {background:rgba(255,255,255,0.05); padding:25px; border-radius:24px; text-align:center; margin-top:20px; border:1px solid rgba(255,255,255,0.1);}
  .map-preview-box {height:180px; background:#222; border-radius:16px; margin-bottom:20px; overflow:hidden; position:relative; border:2px solid rgba(255,255,255,0.1);}
  .active-order-box {background:rgba(255,255,255,0.05); padding:20px; border-radius:20px; border:1px solid rgba(255,255,255,0.1);}
  .step-card {border-left:3px solid #444; padding-left:20px; margin-bottom:25px; position:relative;}
  .step-card.active {border-left-color:var(--primary);}
  .step-card::before {content:''; position:absolute; left:-8px; top:0; width:13px; height:13px; border-radius:50%; background:#444; border:2px solid var(--dark);}
  .step-card.active::before {background:var(--primary); box-shadow:0 0 10px var(--primary);}
  .btn-action {width:100%; padding:15px; border:none; border-radius:12px; font-weight:800; cursor:pointer; margin-top:10px; color:#fff;}
  .btn-pickup {background:#ff9800; box-shadow:0 4px 15px rgba(255,152,0,0.3);}
  .btn-deliver {background:#00c853; box-shadow:0 4px 15px rgba(0,200,83,0.3);}
</style>
</head>
<body>

<div id="map-layer"></div>
<img src="logo-pro.jpg" class="map-logo">

<div class="top-bar">
    <div class="status-pill" onclick="toggleStatus()">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">En ligne</span>
    </div>
    <div class="settings-btn" onclick="openPage('settings')">
        <span class="emoji-anim">⚙️</span> Réglages
    </div>
</div>

<div id="orders-container" class="orders-carousel">
    <div class="empty-state">
        <span class="emoji-anim" style="font-size:2em">📡</span><br>
        Recherche de courses...
    </div>
</div>

<div class="nav-bar">
  <div class="nav-item active" onclick="closeAllPages()">
    <div class="nav-icon emoji-anim">⚡</div>
    <div>Accueil</div>
  </div>
  <div class="nav-item" onclick="openPage('encours')">
    <div class="nav-icon emoji-anim">🎒</div>
    <div>En cours</div>
  </div>
  <div class="nav-item" onclick="openPage('wallet')">
    <div class="nav-icon emoji-anim">💰</div>
    <div>Gains</div>
  </div>
  <div class="nav-item" onclick="openPage('aide')">
    <div class="nav-icon emoji-anim">💬</div>
    <div>Aide</div>
  </div>
  <div class="nav-item" onclick="openPage('profile')">
    <div class="nav-icon emoji-anim">👤</div>
    <div>Compte</div>
  </div>
</div>

<div id="page-settings" class="full-page">
    <div class="bg-logos">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
    </div>
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‹</button>
        <div class="page-title">Réglages</div>
    </div>
    <div class="page-content">
        <div class="menu-list">
             <div class="menu-item" onclick="openRadiusSettings()">
                <span><span class="emoji-anim">🗺️</span> Type de carte (Distance)</span>
                <span class="menu-arrow">❯</span>
            </div>
            <div class="menu-item">
                <span><span class="emoji-anim">🔔</span> Notifications</span>
                <input type="checkbox" checked>
            </div>
        </div>

        <div id="radius-box" class="range-box" style="display:none">
             <h3>Rayon d'action</h3>
             <div class="map-preview-box" id="settingMap"></div>
             <input type="range" min="1" max="50" value="15" oninput="updateRadius(this.value)" style="width:100%">
             <h2 style="color:var(--primary);margin:10px 0"><span id="distVal">15</span> km</h2>
             <button class="btn-save" onclick="document.getElementById('radius-box').style.display='none'">Valider</button>
        </div>
    </div>
</div>

<div id="page-profile" class="full-page">
    <div class="bg-logos">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
    </div>
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‹</button>
        <div class="page-title">Mon Compte</div>
    </div>
    <div class="page-content">
        <div class="profile-header">
            <div class="profile-pic" onclick="document.getElementById('avatarInput').click()">
                <span id="avatarEmoji" class="emoji-anim">📸</span>
                <img id="avatarImg" src="" style="display:none">
            </div>
            <input type="file" id="avatarInput" hidden accept="image/*" onchange="previewAvatar(this)">
            <h2 id="profileName" style="margin:5px 0;color:#fff">Chargement...</h2>
            <p style="color:#aaa;margin:0">Coursier Certifié</p>
        </div>

        <div class="menu-list">
            <div class="menu-item" onclick="openPage('documents')">
                <span><span class="emoji-anim">📂</span> Mes documents</span>
                <span class="menu-arrow">❯</span>
            </div>
            <div class="menu-item" onclick="openPage('transport')">
                <span><span class="emoji-anim">🚲</span> Mon véhicule</span>
                <span class="menu-arrow">❯</span>
            </div>
            <div class="menu-item" style="color:#ff4d4d" onclick="logout()">
                <span><span class="emoji-anim">🔴</span> Déconnexion</span>
                <span class="menu-arrow">❯</span>
            </div>
        </div>
    </div>
</div>

<div id="page-transport" class="full-page">
    <div class="bg-logos">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
    </div>
    <div class="page-header">
        <button class="btn-back-page" onclick="openPage('profile')">‹</button>
        <div class="page-title">Mon Véhicule</div>
    </div>
    <div class="page-content">
        <div class="menu-list" id="vehicleList"></div>
    </div>
</div>

<div id="page-documents" class="full-page">
    <div class="bg-logos">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
    </div>
    <div class="page-header">
        <button class="btn-back-page" onclick="openPage('profile')">‹</button>
        <div class="page-title">Gestion Documents</div>
    </div>
    <div class="page-content">
        <h3 style="margin-left:10px;color:#fff">Mes pièces justificatives</h3>
        <div class="doc-grid">
            <div class="doc-card">
                <div class="doc-card-btn" onclick="alert('Supprimer ?')">🗑️</div>
                <div class="emoji-anim" style="font-size:2em">🆔</div>
                <div style="font-weight:bold;font-size:0.9em">Identité</div>
                <span style="background:rgba(46,125,50,0.5);color:#81c784;padding:2px 6px;border-radius:4px;font-size:0.7em">Validé</span>
            </div>
            <div class="doc-card" onclick="alert('Modifier le RIB')">
                <div class="doc-card-btn">✏️</div>
                <div class="emoji-anim" style="font-size:2em">🏦</div>
                <div style="font-weight:bold;font-size:0.9em">RIB / IBAN</div>
                <span style="background:rgba(239,108,0,0.5);color:#ffcc80;padding:2px 6px;border-radius:4px;font-size:0.7em">À jour</span>
            </div>
            <div class="doc-card">
                 <div class="doc-card-btn">👁️</div>
                <div class="emoji-anim" style="font-size:2em">📑</div>
                <div style="font-weight:bold;font-size:0.9em">Contrat</div>
                <span style="background:rgba(46,125,50,0.5);color:#81c784;padding:2px 6px;border-radius:4px;font-size:0.7em">Signé</span>
            </div>
             <div class="doc-card" style="border:2px dashed #555;background:transparent" onclick="alert('Ajouter un document')">
                <div style="font-size:2em">➕</div>
                <div style="font-weight:bold;color:#888">Ajouter</div>
            </div>
        </div>
    </div>
</div>

<div id="page-aide" class="full-page">
    <div class="bg-logos">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
    </div>
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‹</button>
        <div class="page-title">Aide</div>
    </div>
    <div class="page-content">
        <div class="menu-list">
            <div class="menu-item" onclick="location.href='https://wa.me/33677171188'">
                <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">💬</span> Support WhatsApp</span>
                <span class="menu-arrow">❯</span>
            </div>
            <div class="menu-item" onclick="location.href='tel:+33677171188'">
                <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">📞</span> Appeler l'assistance</span>
                <span class="menu-arrow">❯</span>
            </div>
            <div class="menu-item">
                <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">❓</span> FAQ</span>
                <span class="menu-arrow">❯</span>
            </div>
        </div>
    </div>
</div>

<div id="page-wallet" class="full-page">
    <div class="bg-logos">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
    </div>
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‹</button>
        <div class="page-title">Mes Gains</div>
    </div>
    <div class="page-content" style="text-align:center">
        <div style="background:rgba(255,255,255,0.05);padding:30px;border-radius:25px;border:1px solid rgba(255,255,255,0.1);margin-bottom:20px">
            <div style="color:#aaa;font-weight:600;margin-bottom:10px">Solde actuel</div>
            <div style="font-size:3em;font-weight:900;color:var(--primary)" id="walletAmount">0.00 €</div>
            <button class="btn-save" style="margin-top:20px">Demander un virement</button>
        </div>
        <h3 style="text-align:left;color:#fff;margin-left:10px">Historique</h3>
        <div class="menu-list">
            <div class="menu-item">
                <div>
                    <div style="font-weight:bold">Course #1234</div>
                    <div style="font-size:0.8em;color:#888">Aujourd'hui, 14:30</div>
                </div>
                <div style="color:var(--primary);font-weight:bold">+5.00 €</div>
            </div>
            <div class="menu-item">
                <div>
                    <div style="font-weight:bold">Course #1230</div>
                    <div style="font-size:0.8em;color:#888">Hier, 18:15</div>
                </div>
                <div style="color:var(--primary);font-weight:bold">+8.50 €</div>
            </div>
        </div>
    </div>
</div>

<div id="page-encours" class="full-page">
    <div class="bg-logos">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
        <img src="logo-pro.jpg" class="floating-logo">
    </div>
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‹</button>
        <div class="page-title">Livraison en cours</div>
    </div>
    <div class="page-content" id="activeOrderContent">
        <div style="padding:40px;text-align:center">
            <span class="emoji-anim" style="font-size:5em;display:block;margin-bottom:20px">🤷‍♂️</span>
            <h3 style="color:#fff">Aucune livraison active</h3>
        </div>
    </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let map, marker, settingMap;
let isOnline = true;
let deliveryRadius = 15;
let courierLat = 43.2965;
let courierLon = 5.3698;
let currentOrderId = null;

const VEHICLES = [
    {id:'velo', name:'Vélo', icon:'🚲'},
    {id:'scooter', name:'Scooter', icon:'🛵'},
    {id:'voiture', name:'Voiture', icon:'🚗'},
    {id:'camion', name:'Camion', icon:'🚚'}
];
let currentVehicle = localStorage.getItem('alex_vehicle') || 'velo';
let currentVehicleIcon = '🚲';

function initMap() {
    if(!localStorage.getItem('alex_courier_logged')) {
        window.location.href = 'index.html';
        return;
    }
    
    document.getElementById('profileName').innerText = localStorage.getItem('alex_courier_name') || 'Coursier';
    document.getElementById('walletAmount').innerText = (localStorage.getItem('alex_wallet') || '0.00') + " €";
    
    const savedAvatar = localStorage.getItem('alex_avatar');
    if(savedAvatar) {
        document.getElementById('avatarImg').src = savedAvatar;
        document.getElementById('avatarImg').style.display = 'block';
        document.getElementById('avatarEmoji').style.display = 'none';
    }

    renderVehicleList();
    updateVehicleIcon();

    map = L.map('map-layer', {zoomControl:false}).setView([courierLat, courierLon], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    const iconHtml = `<div class="marker-anim">${currentVehicleIcon}</div>`;
    const customIcon = L.divIcon({
        html: iconHtml,
        className: 'leaflet-div-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    marker = L.marker([courierLat, courierLon], {icon: customIcon}).addTo(map);

    if(navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            courierLat = pos.coords.latitude;
            courierLon = pos.coords.longitude;
            marker.setLatLng([courierLat, courierLon]);
            map.setView([courierLat, courierLon]);
        }, err => console.log(err), {enableHighAccuracy:true});
    }
    
    checkActiveOrder();
    loadAvailableOrders();
}

function toggleStatus() {
    isOnline = !isOnline;
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    if(isOnline) {
        dot.classList.remove('off');
        txt.innerText = "En ligne";
        document.getElementById('map-layer').style.filter = "grayscale(0%)";
    } else {
        dot.classList.add('off');
        txt.innerText = "Hors ligne";
        document.getElementById('map-layer').style.filter = "grayscale(100%)";
    }
}

function renderVehicleList() {
    const list = document.getElementById('vehicleList');
    list.innerHTML = '';
    VEHICLES.forEach(v => {
        const isSel = v.id === currentVehicle;
        list.innerHTML += `
        <div class="menu-item" onclick="setVehicle('${v.id}')">
            <span style="display:flex;align-items:center;gap:10px">
                <span class="emoji-anim">${v.icon}</span> ${v.name}
            </span>
            ${isSel ? '<span style="color:var(--primary)">✔</span>' : ''}
        </div>`;
    });
}

function setVehicle(id) {
    currentVehicle = id;
    localStorage.setItem('alex_vehicle', id);
    renderVehicleList();
    updateVehicleIcon();
    
    // Update marker
    const iconHtml = `<div class="marker-anim">${currentVehicleIcon}</div>`;
    const customIcon = L.divIcon({
        html: iconHtml,
        className: 'leaflet-div-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });
    marker.setIcon(customIcon);
}

function updateVehicleIcon() {
    const v = VEHICLES.find(x => x.id === currentVehicle);
    currentVehicleIcon = v ? v.icon : '🚲';
}

function openPage(id) {
    document.querySelectorAll('.full-page').forEach(p => p.style.display = 'none');
    document.getElementById('page-' + id).style.display = 'flex';
}
function closeAllPages() {
    document.querySelectorAll('.full-page').forEach(p => p.style.display = 'none');
}

function openRadiusSettings(){
    const box = document.getElementById('radius-box');
    box.style.display = 'block';
    if(!settingMap) {
        setTimeout(() => {
            settingMap = L.map('settingMap', {zoomControl:false}).setView([courierLat, courierLon], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(settingMap);
            L.circle([courierLat, courierLon], {color: '#00c853', radius: deliveryRadius * 1000}).addTo(settingMap);
        }, 200);
    }
}
function updateRadius(val) {
    deliveryRadius = val;
    document.getElementById('distVal').innerText = val;
}

function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarImg').src = e.target.result;
            document.getElementById('avatarImg').style.display = 'block';
            localStorage.setItem('alex_avatar', e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// --- COURIER DASHBOARD LOGIC ---
const VEHICLE_CAPACITY = {
    'velo': ['Petit (S)'],
    'scooter': ['Petit (S)', 'Moyen (M)'],
    'voiture': ['Petit (S)', 'Moyen (M)', 'Grand (L)'],
    'camion': ['Petit (S)', 'Moyen (M)', 'Grand (L)', 'Très Grand (XL)']
};

function loadAvailableOrders() {
    const ordersList = document.getElementById('orders-container'); 
    if(!ordersList) return; 

    db.collection('orders')
      .where('status', 'in', ['pending', 'pending_payment', 'paid']) 
      .where('deliveryType', '==', 'Livraison')
      .orderBy('createdAt', 'desc')
      .onSnapshot(snapshot => {
          ordersList.innerHTML = ''; 
          if (snapshot.empty) {
              ordersList.innerHTML = '<div class="empty-state"><span class="emoji-anim" style="font-size:2em">📡</span><br>Aucune commande disponible.</div>';
              return;
          }
          snapshot.forEach(doc => {
              const order = doc.data();
              order.id = doc.id;
              const orderSize = order.parcelSize || 'Petit (S)';
              const allowedSizes = VEHICLE_CAPACITY[currentVehicle] || VEHICLE_CAPACITY['velo'];
              
              // Filter logic
              if (!allowedSizes.includes(orderSize)) return; 
              
              renderOrderCard(order, ordersList);
          });
      });
}

function renderOrderCard(order, container) {
    const html = `
        <div class="order-card">
            <div class="order-head">
                <span class="shop-name"><span class="emoji-anim">🏪</span> ${order.shopName}</span>
                <span class="order-price">${order.totalPrice}€</span>
            </div>
            <div class="big-info">
                <div class="info-tag"><span class="emoji-anim">📦</span> Volume: <strong style="color:#fff;">${order.parcelSize || 'Petit (S)'}</strong></div>
                <div class="info-tag"><span class="emoji-anim">📍</span> De: ${order.from}</div>
                <div class="info-tag"><span class="emoji-anim">🏁</span> Vers: ${order.to}</div>
                <div class="info-tag"><span class="emoji-anim">🕒</span> Pour: ${order.deliveryTime}</div>
            </div>
            <button onclick="acceptOrder('${order.id}')" class="btn-accept">Accepter la course</button>
        </div>
    `;
    container.innerHTML += html;
}

async function acceptOrder(id) {
    await db.collection('orders').doc(id).update({status: 'accepted', courierId: localStorage.getItem('alex_courier_id')});
    currentOrderId = id;
    checkActiveOrder();
    openPage('encours');
}

function checkActiveOrder() {
    const uid = localStorage.getItem('alex_courier_id');
    db.collection('orders').where('courierId', '==', uid).where('status', 'in', ['accepted', 'picked_up']).onSnapshot(snap => {
        if(!snap.empty) {
            const doc = snap.docs[0];
            currentOrderId = doc.id;
            renderActiveUI(doc.id, doc.data());
        } else {
            currentOrderId = null;
            document.getElementById('activeOrderContent').innerHTML = '<div style="padding:40px;text-align:center"><span class="emoji-anim" style="font-size:5em;display:block;margin-bottom:20px">🤷‍♂️</span><h3 style="color:#fff">Aucune livraison</h3></div>';
        }
    });
}

function renderActiveUI(id, data){
    const isPicked = data.status === 'picked_up';
    document.getElementById('activeOrderContent').innerHTML = `
        <div class="active-order-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h2 style="margin:0;color:#fff">En Cours</h2>
                <div class="emoji-anim" style="font-size:2.5em">${currentVehicleIcon}</div>
            </div>
            <div class="step-card ${!isPicked?'active':''}">
                <div style="font-weight:bold;margin-bottom:5px;display:flex;align-items:center;gap:5px;color:#fff"><span class="emoji-anim">📍</span> Restaurant</div>
                <div style="color:#ccc;font-size:0.9em;white-space:normal;word-break:break-word">${data.from}</div>
                ${!isPicked ? `<button class="btn-action btn-pickup" onclick="db.collection('orders').doc('${id}').update({status:'picked_up'})">📦 Colis Récupéré</button>` : ''}
            </div>
            <div class="step-card ${isPicked?'active':''}">
                <div style="font-weight:bold;margin-bottom:5px;display:flex;align-items:center;gap:5px;color:#fff"><span class="emoji-anim">🏁</span> Client</div>
                <div style="color:#ccc;font-size:0.9em;white-space:normal;word-break:break-word">${data.to}</div>
                ${isPicked ? `<button class="btn-action btn-deliver" onclick="finishOrder('${id}')">✅ Livré</button>` : ''}
            </div>
        </div>
    `;
}

function finishOrder(id){
    db.collection('orders').doc(id).update({status:'delivered'});
    const w = parseFloat(localStorage.getItem('alex_wallet')||0) + 5.00;
    localStorage.setItem('alex_wallet', w.toFixed(2));
    document.getElementById('walletAmount').innerText = w.toFixed(2) + " €";
    currentOrderId = null;
    alert("Bravo ! Course terminée.");
    closeAllPages();
}

function logout() {
    if(confirm("Déconnexion ?")) {
        localStorage.removeItem('alex_courier_logged');
        window.location.href = 'index.html';
    }
}

window.onload = initMap;
</script>
</body>
</html>