<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>AlexLivraison Pro</title>

<meta name="theme-color" content="#6b23ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Alex Pro">
<link rel="apple-touch-icon" href="logo2.jpg">
<link rel="icon" type="image/jpeg" href="logo2.jpg">
<link rel="manifest" href="./manifest-pro.json">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  :root{
    --primary:#6b23ff;
    --accent:#00e676;
    --bg:#f2f2f7;
    --text:#1d1d1f;
    --surface:#ffffff;
    --shadow:0 8px 30px rgba(0,0,0,0.12);
  }
  * {box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  body {
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background:var(--bg); margin:0; padding:0; color:var(--text);
    height:100vh; overflow:hidden; display:flex; flex-direction:column;
  }
  #map-layer {
    position:absolute; top:0; left:0; width:100%; height:100%; z-index:0;
  }
  
  .leaflet-top { top: 120px; }

  .map-logo {
      position: absolute; top: 15px; left: 42%; transform: translateX(-50%);
      width: 55px; height: 55px;
      border-radius: 50%; border: 3px solid #fff; box-shadow: var(--shadow);
      z-index: 20; object-fit: cover; animation: floatLogo 4s ease-in-out infinite;
  }
  @keyframes floatLogo { 0%,100%{transform:translate(-50%, 0);} 50%{transform:translate(-50%, -5px);} }

  .top-bar {
      position: absolute; top: 0; left: 0; width: 100%; z-index: 10;
      padding: 15px 15px; display: flex; justify-content: space-between; align-items: flex-start;
      pointer-events: none;
  }
  
  .status-pill {
      pointer-events: auto;
      background: #fff; padding: 8px 12px; border-radius: 50px;
      display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 0.85em;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s;
  }
  .status-pill:active { transform: scale(0.95); }
  .dot {width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent);}
  .dot.off {background: #ff4d4d; box-shadow: 0 0 8px #ff4d4d;}
  
  .settings-btn {
      pointer-events: auto;
      background: #fff; padding: 8px 12px; border-radius: 50px;
      display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 0.85em;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s;
      color: var(--text);
  }
  .settings-btn:active { transform: scale(0.95); }

  .orders-carousel {
      position: absolute; bottom: 85px; left: 0; right: 0; z-index: 10;
      display: flex; gap: 8px; overflow-x: auto; padding: 0 10px;
      scroll-snap-type: x mandatory; scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch; padding-bottom: 5px;
  }
  .orders-carousel::-webkit-scrollbar {display: none;}
  
  .order-card {
      min-width: 200px; max-width: 220px; background: #fff;
      border-radius: 12px; 
      padding: 6px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      scroll-snap-align: center; border-left: 3px solid var(--primary);
      display: flex; flex-direction: column; justify-content: space-between;
      animation: popIn 0.3s ease-out;
  }
  @keyframes popIn { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }
  
  .order-head {
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 2px;
  }
  .shop-name {font-weight: 700; font-size: 0.8em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;}
  .order-price {background: #6b23ff; color: #fff; padding: 2px 6px; border-radius: 6px; font-weight: 700; font-size: 0.8em;}
  
  .big-info {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 2px; 
      background: #f0f2f5; border-radius: 8px; 
      margin-bottom: 2px; 
      border: 1px solid #fff;
  }
  .arrow-down { font-size: 0.9em; color: #ff9800; margin: 0; font-weight: bold; line-height: 1; }
  .info-tag {
      background: #fff; padding: 1px 6px; border-radius: 4px; font-weight: 700; font-size: 0.75em; color: #32006b;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #32006b; margin-top: 1px;
  }

  .btn-accept {
      width: 100%; 
      padding: 5px; 
      background: linear-gradient(90deg, #6b23ff, #8e5aff); color: #fff; border: none;
      border-radius: 8px; font-weight: 700; font-size: 0.85em; cursor: pointer;
      box-shadow: 0 2px 6px rgba(107,35,255,0.3); transition: 0.2s;
  }

  .btn-accept:active { transform: scale(0.98); }
  .btn-accept:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

  .empty-state {
      position: absolute; bottom: 130px; width: 90%; left: 5%; text-align: center;
      color: #666; font-weight: 600; background: rgba(255,255,255,0.9);
      padding: 15px; border-radius: 15px; box-shadow: var(--shadow); backdrop-filter: blur(10px);
  }

  .full-page {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f2f2f7; z-index: 100; display: none; flex-direction: column;
      overflow-y: auto;
  }
  .page-content {
      flex: 1; overflow-y: auto; padding-bottom: 100px;
  }
  .page-header {
      background: #fff; padding: 15px 20px; padding-top: 50px;
      display: flex; align-items: center; gap: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 101;
  }
  .btn-back-page { 
      width: 40px; height: 40px; border-radius: 50%; border: none; background: #f5f5f5; 
      font-size: 1.8em; cursor: pointer; display: flex; align-items: center; justify-content: center;
      color: var(--primary); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      font-family: monospace; padding-bottom: 4px;
  }
  .btn-back-page:hover, .btn-back-page:active {
      transform: scale(1.1); background: #e0e0e0;
      animation: backPulse 0.6s infinite;
  }
  @keyframes backPulse { 0% { transform: translateX(0) scale(1.1); } 50% { transform: translateX(-3px) scale(1.1); } 100% { transform: translateX(0) scale(1.1); } }

  .page-title { font-size: 1.3em; font-weight: 800; flex: 1; color: #1c1c1e; }

  .settings-content { padding: 25px; }
  .range-box { 
      background: #fff; padding: 25px; border-radius: 24px; text-align: center; margin-top: 20px; 
      box-shadow: var(--shadow);
  }
  .map-preview-box {
      height: 180px; background: #eee; border-radius: 16px; margin-bottom: 20px;
      overflow: hidden; position: relative; border: 2px solid #fff; box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
  }
  .slider-container { position: relative; width: 100%; padding: 10px 0; }
  input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
  input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%; 
      background: #ffffff; border: 4px solid #007bff; cursor: pointer; margin-top: -12px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 6px; cursor: pointer; background: #007bff; border-radius: 3px;
  }
  .range-val { font-size: 1.2em; font-weight: 800; color: #007bff; margin-top: 10px; display: block; }

  .profile-header {
      background: #fff; padding: 40px 20px; text-align: center; margin-bottom: 20px;
      border-radius: 0 0 30px 30px; box-shadow: var(--shadow);
  }
  .profile-pic {
      width: 100px; height: 100px; border-radius: 50%; background: #f0f2f5; margin: 0 auto 15px;
      display: flex; align-items: center; justify-content: center; font-size: 3em;
      border: 4px solid var(--primary); overflow: hidden; position: relative;
      box-shadow: 0 10px 20px rgba(107,35,255,0.2); cursor: pointer;
  }
  .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
  .upload-overlay {
      position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: #fff; 
      font-size: 10px; padding: 3px 0; font-weight: bold;
  }
  
  .menu-list { background: #fff; border-radius: 20px; margin: 0 20px 20px 20px; overflow: hidden; box-shadow: var(--shadow); }
  .menu-item {
      padding: 18px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between;
      align-items: center; cursor: pointer; font-weight: 600; font-size: 1em; color: #333;
      transition: 0.2s;
  }
  .menu-item:active { background: #f9f9f9; }
  .menu-item:last-child { border-bottom: none; }
  .menu-arrow { width: 24px; height: 24px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; }

  .doc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
  .doc-card {
      background: #fff; padding: 15px; border-radius: 16px; text-align: center;
      box-shadow: var(--shadow); aspect-ratio: 1; display: flex; flex-direction: column;
      justify-content: center; align-items: center; gap: 8px; transition: 0.2s;
  }
  .doc-card:active { transform: scale(0.98); }
  .doc-icon { font-size: 2.2em; }
  .doc-label { font-size: 0.8em; font-weight: 700; color: #555; }
  .doc-status { font-size: 0.7em; font-weight: 800; color: #00c853; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; }

  .data-box { background: #fff; border-radius: 16px; padding: 20px; margin: 20px; box-shadow: var(--shadow); }
  .data-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .data-row:last-child { border: none; margin: 0; padding: 0; }
  .data-label { color: #888; font-size: 0.9em; font-weight: 600; }
  .data-value { font-weight: 700; color: #333; }

  .nav-bar {
    position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.98);
    backdrop-filter:blur(20px); border-top:1px solid rgba(0,0,0,0.05);
    display:flex; justify-content:space-around; padding:12px 0; padding-bottom:30px; z-index:50;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
  }
  .nav-item {
    display:flex; flex-direction:column; align-items:center; gap:5px; color:#aaa; font-size:0.75em; font-weight: 700; cursor:pointer; width: 20%; transition: 0.3s;
  }
  .nav-item.active { color:var(--primary); transform: translateY(-4px); }
  .nav-icon { font-size:1.7em; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }

  .emoji-anim { display: inline-block; animation: stickerFloat 3s ease-in-out infinite; }
  @keyframes stickerFloat {
    0% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-5px) rotate(5deg); }
    100% { transform: translateY(0) rotate(0deg); }
  }

  @keyframes bikeRide {
    0% { transform: translate(-10px, -10px) rotate(0deg); }
    25% { transform: translate(-10px, -12px) rotate(-2deg); }
    50% { transform: translate(-10px, -10px) rotate(0deg); }
    75% { transform: translate(-10px, -12px) rotate(2deg); }
    100% { transform: translate(-10px, -10px) rotate(0deg); }
  }
  .marker-c div { animation: bikeRide 1s infinite linear; }

  .btn-save {
      width: 100%; padding: 16px; background: #007bff; color: #fff; border: none;
      border-radius: 50px; font-weight: 800; font-size: 1.1em; margin-top: 20px; cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,123,255,0.3);
  }
  
  .banner-alert {
      background: #fff3e0; color: #ef6c00; padding: 10px; border-radius: 12px; margin: 15px; text-align: center; font-weight: 700; font-size: 0.9em;
  }

  .active-order-box {
      background: #fff; margin: 20px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow);
  }
  .step-card {
      border-left: 2px solid #ddd; padding-left: 20px; margin-bottom: 20px; position: relative;
  }
  .step-card::before {
      content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: #ccc;
  }
  .step-card.active { border-left-color: var(--primary); }
  .step-card.active::before { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
  .step-title { font-weight: 700; font-size: 1.1em; margin-bottom: 5px; }
  .step-addr { font-size: 0.9em; color: #666; }
  
  .btn-action {
      width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 800; font-size: 1em; cursor: pointer;
      margin-top: 10px; transition: 0.2s;
  }
  .btn-pickup { background: #ff9800; color: #fff; box-shadow: 0 4px 15px rgba(255,152,0,0.3); }
  .btn-deliver { background: #00c853; color: #fff; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
  .btn-cancel { background: #ff4d4d; color: #fff; margin-top: 15px; font-size: 0.9em; }

  .pwa-install-btn {
      position: fixed;
      bottom: 90px; 
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, #6b23ff, #007bff);
      color: white;
      padding: 12px 25px;
      border-radius: 50px;
      font-weight: 800;
      font-size: 0.9em;
      border: none;
      box-shadow: 0 10px 30px rgba(107, 35, 255, 0.5);
      z-index: 900;
      display: none;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      animation: pulse 2s infinite;
      white-space: nowrap;
  }
  .pwa-install-btn:active { transform: translateX(-50%) scale(0.95); }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(107, 35, 255, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(107, 35, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(107, 35, 255, 0); } }

  .ios-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 20px;
  }
  .ios-content {
      background: white;
      width: 90%;
      max-width: 400px;
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      position: relative;
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .ios-content h3 { margin: 0 0 10px 0; color: #333; }
  .ios-content p { color: #666; margin-bottom: 20px; line-height: 1.5; }
  .ios-icon { width: 60px; height: 60px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  .ios-arrow { position: absolute; bottom: -45px; left: 50%; transform: translateX(-50%); font-size: 40px; color: white; animation: bounce 2s infinite; }
  .ios-close { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #999; cursor: pointer; background: none; border: none; }
  @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
  @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);} 40% {transform: translateX(-50%) translateY(-10px);} 60% {transform: translateX(-50%) translateY(-5px);} }

</style>
</head>
<body>

<div id="map-layer"></div>
<img src="logo2.jpg" class="map-logo">

<button id="pwaInstallBtn" class="pwa-install-btn">
    <span class="emoji-anim">üì≤</span> Installer l'application Pro
</button>

<div id="iosInstallModal" class="ios-modal">
    <div class="ios-content">
        <button class="ios-close" onclick="document.getElementById('iosInstallModal').style.display='none'">√ó</button>
        <img src="logo2.jpg" class="ios-icon" alt="Icon">
        <h3>Installer l'app Pro</h3>
        <p>Pour installer sur iPhone, appuyez sur <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/Ios_share_icon.svg" style="width:18px;display:inline;vertical-align:middle"> puis <strong>Sur l'√©cran d'accueil</strong>.</p>
        <div class="ios-arrow">‚Üì</div>
    </div>
</div>

<div class="top-bar">
    <div class="status-pill" onclick="toggleStatus()">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">En ligne</span>
    </div>
    <div class="settings-btn" onclick="openPage('settings')">
        <span class="emoji-anim">‚öôÔ∏è</span>
        <span>R√©glages</span>
    </div>
</div>

<div id="orders-container" class="orders-carousel">
    <div class="empty-state">
        <span class="emoji-anim" style="font-size:2em">üì°</span><br>
        Recherche de courses...
    </div>
</div>

<div class="nav-bar">
  <div class="nav-item active" onclick="closeAllPages()">
    <div class="nav-icon"><span class="emoji-anim">‚ö°</span></div>
    <div>Accueil</div>
  </div>
  <div class="nav-item" onclick="openPage('encours')">
    <div class="nav-icon"><span class="emoji-anim">üéí</span></div>
    <div>En cours</div>
  </div>
  <div class="nav-item" onclick="openPage('wallet')">
    <div class="nav-icon"><span class="emoji-anim">üí∞</span></div>
    <div>Gains</div>
  </div>
  <div class="nav-item" onclick="openPage('aide')">
    <div class="nav-icon"><span class="emoji-anim">üí¨</span></div>
    <div>Aide</div>
  </div>
  <div class="nav-item" onclick="openPage('profile')">
    <div class="nav-icon"><span class="emoji-anim">üë§</span></div>
    <div>Compte</div>
  </div>
</div>

<div id="page-settings" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Rayon de livraison</div>
    </div>
    <div class="page-content">
        <div class="settings-content">
            <div style="text-align:center;color:#666;margin-bottom:15px">D√©finissez votre zone d'activit√©</div>
            <div class="range-box">
                <div class="map-preview-box" id="settingMap"></div>
                <div class="slider-container">
                    <input type="range" min="1" max="50" value="22" oninput="updateRadius(this.value)">
                </div>
                <span class="range-val"><span id="distVal">22</span> km</span>
            </div>
            <button class="btn-save" onclick="closeAllPages()">Enregistrer</button>
        </div>
    </div>
</div>

<div id="page-profile" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Mon Compte</div>
    </div>
    <div class="page-content">
        <div class="profile-header">
            <div class="profile-pic" onclick="document.getElementById('avatarInput').click()">
                <span id="avatarEmoji" class="emoji-anim">üì∏</span>
                <img id="avatarImg" src="" style="display:none">
                <div class="upload-overlay">Modifier</div>
            </div>
            <input type="file" id="avatarInput" hidden accept="image/*" onchange="previewAvatar(this)">
            <h2 style="margin:0;color:#333" id="profileName">Chargement...</h2>
            <p style="color:#888;margin:5px 0;font-weight:500" id="profileEmail">...</p>
            <div class="banner-alert"><span class="emoji-anim">‚è≥</span> En attente de validation</div>
        </div>

        <div class="menu-list">
            <div class="menu-item" onclick="openPage('perso')">
                <span><span class="emoji-anim">üë§</span> Mes coordonn√©es</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item" onclick="openPage('documents')">
                <span><span class="emoji-anim">üìÇ</span> Mes documents</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item" onclick="openPage('transport')">
                <span><span class="emoji-anim">üõµ</span> Mon moyen de transport</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item" onclick="openPage('settings')">
                <span><span class="emoji-anim">‚öôÔ∏è</span> Param√®tres</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
            <div class="menu-item" style="color:red" onclick="logout()">
                <span><span class="emoji-anim">üî¥</span> D√©connexion</span>
                <span class="menu-arrow">‚ùØ</span>
            </div>
        </div>
    </div>
</div>

<div id="page-perso" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="openPage('profile')">‚Äπ</button>
        <div class="page-title">Mes coordonn√©es</div>
    </div>
    <div class="page-content">
        <div class="data-box">
            <div class="data-row"><span class="data-label">Nom complet</span><span class="data-value" id="infoName">-</span></div>
            <div class="data-row"><span class="data-label">T√©l√©phone</span><span class="data-value" id="infoPhone">-</span></div>
            <div class="data-row"><span class="data-label">Email</span><span class="data-value" id="infoEmail">-</span></div>
            <div class="data-row"><span class="data-label">Adresse</span><span class="data-value" id="infoAddr">-</span></div>
            <div class="data-row"><span class="data-label">SIREN</span><span class="data-value" id="infoSiren">-</span></div>
        </div>
    </div>
</div>

<div id="page-transport" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="openPage('profile')">‚Äπ</button>
        <div class="page-title">Mon V√©hicule</div>
    </div>
    <div class="page-content">
        <div style="text-align:center;padding:40px">
            <div style="font-size:5em;margin-bottom:20px" class="emoji-anim" id="vehIcon">üõµ</div>
            <h2 id="vehName">Scooter</h2>
            <p style="color:#666">V√©hicule d√©clar√© pour les livraisons.</p>
            <button class="btn-save" style="background:#eee;color:#333;margin-top:30px">Changer de v√©hicule</button>
        </div>
    </div>
</div>

<div id="page-documents" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="openPage('profile')">‚Äπ</button>
        <div class="page-title">Mes Documents</div>
    </div>
    <div class="page-content">
        <div class="doc-grid">
            <div class="doc-card">
                <div class="doc-icon emoji-anim">üÜî</div>
                <div class="doc-label">Identit√© (R/V)</div>
                <span class="doc-status">Re√ßu</span>
            </div>
            <div class="doc-card">
                <div class="doc-icon emoji-anim">üè¶</div>
                <div class="doc-label">RIB / IBAN</div>
                <span class="doc-status" style="background:#fff3e0;color:#e65100">√Ä ajouter</span>
            </div>
            <div class="doc-card">
                <div class="doc-icon emoji-anim">üìÑ</div>
                <div class="doc-label">Contrat</div>
                <span class="doc-status">Sign√©</span>
            </div>
            <div class="doc-card">
                <div class="doc-icon emoji-anim">üì∏</div>
                <div class="doc-label">Selfie</div>
                <span class="doc-status">Valid√©</span>
            </div>
        </div>
    </div>
</div>

<div id="page-aide" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Centre d'aide</div>
    </div>
    <div class="page-content">
        <div style="padding:20px">
            <h3 style="color:#333;margin-bottom:15px">Nous sommes l√† pour vous aider</h3>
            <div class="menu-list" style="margin:0;box-shadow:none;border:1px solid #eee">
                <div class="menu-item" onclick="location.href='https://wa.me/33677171188'">
                    <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">üí¨</span> Support WhatsApp</span>
                    <span class="menu-arrow">‚ùØ</span>
                </div>
                <div class="menu-item" onclick="location.href='tel:+33677171188'">
                    <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">üìû</span> Appeler l'assistance</span>
                    <span class="menu-arrow">‚ùØ</span>
                </div>
                <div class="menu-item">
                    <span style="display:flex;align-items:center;gap:10px"><span class="emoji-anim">‚ùì</span> Toute la FAQ</span>
                    <span class="menu-arrow">‚ùØ</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="page-wallet" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Ma Cagnotte</div>
    </div>
    <div class="page-content">
        <div style="padding:20px">
            <div style="background:linear-gradient(45deg,#ff6b6b,#ee5253);padding:30px;border-radius:20px;color:#fff;text-align:center;box-shadow:0 10px 30px rgba(238,82,83,0.3)">
                <div style="opacity:0.8;font-weight:600">Solde actuel</div>
                <div style="font-size:2.5em;font-weight:900;margin:10px 0" id="walletAmount">0,00 ‚Ç¨</div>
            </div>
            <button class="btn-save" style="background:#fff;color:#333;border:1px solid #ddd;margin-top:15px">üè¶ Effectuer un virement</button>
            <h3 style="margin-top:30px;color:#32006b">Derni√®res transactions</h3>
            <div id="tx-history" style="text-align:center;color:#999;margin-top:20px;font-style:italic">Aucune transaction r√©cente</div>
        </div>
    </div>
</div>

<div id="page-encours" class="full-page">
    <div class="page-header">
        <button class="btn-back-page" onclick="closeAllPages()">‚Äπ</button>
        <div class="page-title">Course en cours</div>
    </div>
    <div class="page-content" id="activeOrderContent">
        <div style="padding:40px;text-align:center">
            <span class="emoji-anim" style="font-size:5em;display:block;margin-bottom:20px">ü§∑‚Äç‚ôÇÔ∏è</span>
            <h3 style="color:#333">Aucune livraison en cours</h3>
            <p style="color:#666">Activez le mode "En ligne" pour recevoir des commandes.</p>
        </div>
    </div>
</div>

<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw-pro.js', {scope: './'})
            .then(reg => console.log('SW registered'))
            .catch(err => console.log('SW failed', err));
    });
}

const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

if(!localStorage.getItem('alex_courier_logged')) window.location.href='login.html';

let map, isOnline = true;
let settingMap;
let courierLat = 43.1242;
let courierLon = 5.928;
let deliveryRadius = localStorage.getItem('alex_radius') ? parseInt(localStorage.getItem('alex_radius')) : 22;
let courierMarker;
const MAPBOX_TOKEN="pk.eyJ1IjoiYWxleGxpdnJldXIiLCJhIjoiY21oZjRsODBxMDFpMTJrc2NuM3JyY2VrdyJ9.kErrSMRoIXzWqp9wnlayMg";
const coordCache = {};
let allOrdersData = [];
let currentOrderId = null;
let currentOrderData = null;

let deferredPrompt;
const installBtn = document.getElementById('pwaInstallBtn');
const iosModal = document.getElementById('iosInstallModal');
const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);

if (!isInStandaloneMode) {
  if (isIos) {
      installBtn.style.display = 'flex';
      installBtn.addEventListener('click', () => {
          iosModal.style.display = 'flex';
      });
  } else {
      window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installBtn.style.display = 'flex';
      });
      installBtn.addEventListener('click', (e) => {
          if (deferredPrompt) {
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then((choiceResult) => {
                  if (choiceResult.outcome === 'accepted') {
                      installBtn.style.display = 'none';
                  }
                  deferredPrompt = null;
              });
          }
      });
  }
}

function initMap() {
  map = L.map('map-layer', {zoomControl: true, attributionControl: false}).setView([courierLat, courierLon], 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
  const icon = L.divIcon({html: '<div style="font-size:24px;transform:translate(-10px,-10px)">üö¥</div>', className: 'marker-c'});
  courierMarker = L.marker([courierLat, courierLon], {icon: icon}).addTo(map);
  
  if(navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
          courierLat = pos.coords.latitude;
          courierLon = pos.coords.longitude;
          courierMarker.setLatLng([courierLat, courierLon]);
          if(currentOrderId == null) map.setView([courierLat, courierLon], 13);
          
          const uid = localStorage.getItem('alex_courier_id');
          if(uid) db.collection('couriers').doc(uid).set({
              lat: courierLat, lng: courierLon, lastSeen: new Date()
          }, {merge:true});

      }, err => console.log(err), {enableHighAccuracy:true});
  }

  const savedAvatar = localStorage.getItem('alex_avatar');
  if(savedAvatar) {
      document.getElementById('avatarImg').src = savedAvatar;
      document.getElementById('avatarImg').style.display = 'block';
      document.getElementById('avatarEmoji').style.display = 'none';
  }

  document.querySelector('input[type=range]').value = deliveryRadius;
  document.getElementById('distVal').innerText = deliveryRadius;
  updateWalletUI();
  loadUserData();
  loadOrders();
  checkActiveOrder();
  
  if (Notification.permission !== "granted") {
      Notification.requestPermission();
  }
}

function loadUserData() {
    const name = localStorage.getItem('alex_courier_name') || 'Coursier';
    document.getElementById('profileName').innerText = name;
    document.getElementById('profileEmail').innerText = "coursier@alex.com";
    document.getElementById('infoName').innerText = name;
    document.getElementById('infoEmail').innerText = "coursier@alex.com";
    document.getElementById('infoPhone').innerText = "06 12 34 56 78";
    document.getElementById('infoAddr').innerText = "Toulon, France";
    document.getElementById('infoSiren').innerText = "En attente";
}

function toggleStatus() {
    isOnline = !isOnline;
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    if (isOnline) {
        dot.classList.remove('off'); txt.innerText = "En ligne"; 
        renderOrders();
    } else {
        dot.classList.add('off'); txt.innerText = "Hors ligne";
        document.getElementById('orders-container').innerHTML = '<div class="empty-state">Vous √™tes hors ligne</div>';
    }
}

function getDist(lat1, lon1, lat2, lon2) {
    const R = 6371; 
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function loadOrders() {
    db.collection('orders').where('status', '==', 'pending').onSnapshot(snap => {
        if (!isOnline && snap.docChanges().some(change => change.type === 'added')) {
             new Notification("üîî Nouvelle course disponible !", {
                body: "Un client vient de passer commande.",
                icon: "logo2.jpg"
             });
        }
        allOrdersData = [];
        snap.forEach(doc => {
            allOrdersData.push({id: doc.id, ...doc.data()});
        });
        renderOrders();
    });
}

async function renderOrders() {
    if(!isOnline || currentOrderId) {
        document.getElementById('orders-container').innerHTML = currentOrderId ? 
            '<div class="empty-state">Course en cours...</div>' : 
            '<div class="empty-state">Vous √™tes hors ligne</div>';
        return;
    }

    const container = document.getElementById('orders-container');
    container.innerHTML = '';
    
    if (allOrdersData.length === 0) {
        container.innerHTML = '<div class="empty-state">Recherche de courses...</div>';
        return;
    }

    const courierWallet = parseFloat(localStorage.getItem('alex_wallet') || '0');

    for (const o of allOrdersData) {
        let lat, lon;
        if (coordCache[o.from]) {
            [lat, lon] = coordCache[o.from];
        } else {
            try {
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(o.from)}.json?limit=1&access_token=${MAPBOX_TOKEN}`;
                const res = await fetch(url);
                const data = await res.json();
                if(data.features && data.features.length > 0) {
                    const center = data.features[0].center;
                    lon = center[0];
                    lat = center[1];
                    coordCache[o.from] = [lat, lon];
                } else continue;
            } catch(e) { continue; }
        }

        const dist = getDist(courierLat, courierLon, lat, lon);
        if(dist <= deliveryRadius) {
            const isCash = o.paymentMethod === 'cash';
            const orderTotal = parseFloat(o.price);
            let btnHtml = '';

            if (isCash && courierWallet < orderTotal) {
                btnHtml = `<button class="btn-accept" disabled style="background:#ccc;cursor:not-allowed">
                             ‚ö†Ô∏è Solde insuffisant
                           </button>`;
            } else {
                btnHtml = `<button class="btn-accept" onclick="acceptOrder('${o.id}', ${orderTotal}, '${o.paymentMethod}')">ACCEPTER</button>`;
            }

            const card = document.createElement('div');
            card.className = 'order-card';
            card.innerHTML = `
                <div class="order-head">
                    <div class="shop-name">${o.shopName || 'Restaurant'}</div>
                    <div class="order-price" style="${isCash ? 'background:#ff9800' : 'background:#6b23ff'}">
                        ${o.price} ‚Ç¨ ${isCash ? '(ESP√àCES)' : '(CB)'}
                    </div>
                </div>
                <div class="big-info">
                    <div style="font-size:0.65em;font-weight:700;margin-bottom:1px">üìç ${o.from}</div>
                    <div class="arrow-down">‚¨á</div>
                    <div style="font-size:0.65em;font-weight:700;margin-bottom:3px">üèÅ ${o.to}</div>
                </div>
                ${btnHtml}
            `;
            container.appendChild(card);
        }
    }
}

async function acceptOrder(id, price, method) {
    const uid = localStorage.getItem('alex_courier_id');
    
    if (method === 'cash') {
        let w = parseFloat(localStorage.getItem('alex_wallet') || '0');
        if (w < price) return alert("Solde insuffisant pour ce paiement esp√®ce.");
        w -= price; 
        localStorage.setItem('alex_wallet', w.toFixed(2));
        updateWalletUI();
    }

    try {
        await db.collection('orders').doc(id).update({
            status: 'accepted',
            courierId: uid || 'unknown',
            acceptedAt: new Date()
        });
        currentOrderId = id;
        openPage('encours');
        checkActiveOrder(); 
        document.getElementById('orders-container').innerHTML = '<div class="empty-state">Course en cours...</div>';
    } catch(e) {
        alert("Erreur: " + e.message);
    }
}

function checkActiveOrder() {
    const uid = localStorage.getItem('alex_courier_id');
    db.collection('orders')
      .where('courierId', '==', uid)
      .where('status', 'in', ['accepted', 'picked_up'])
      .limit(1)
      .onSnapshot(snap => {
          if(!snap.empty) {
              const doc = snap.docs[0];
              currentOrderId = doc.id;
              currentOrderData = doc.data();
              renderActiveOrderUI(currentOrderData);
          } else {
              currentOrderId = null;
              currentOrderData = null;
              document.getElementById('activeOrderContent').innerHTML = `
                <div style="padding:40px;text-align:center">
                    <span class="emoji-anim" style="font-size:5em;display:block;margin-bottom:20px">ü§∑‚Äç‚ôÇÔ∏è</span>
                    <h3 style="color:#333">Aucune livraison en cours</h3>
                </div>`;
              renderOrders();
          }
      });
}

function renderActiveOrderUI(data) {
    const isPickedUp = data.status === 'picked_up';
    const deliveryFee = 5.00;
    const html = `
        <div class="active-order-box">
            <h2 style="margin-top:0">+${deliveryFee} ‚Ç¨ <span style="font-size:0.6em;color:#888;font-weight:400">Gain livraison</span></h2>
            <div class="step-card ${!isPickedUp ? 'active' : ''}">
                <div class="step-title">Restaurant</div>
                <div class="step-addr">${data.from}</div>
                ${!isPickedUp ? `<button class="btn-action btn-pickup" onclick="updateOrderStatus('picked_up')">üì¶ Commande r√©cup√©r√©e</button>` : ''}
            </div>
            <div class="step-card ${isPickedUp ? 'active' : ''}">
                <div class="step-title">Client</div>
                <div class="step-addr">${data.to}</div>
                <div style="font-size:0.8em;color:#666;margin-top:5px">üìû ${data.customer ? data.customer.phone : 'Tel masqu√©'}</div>
                ${isPickedUp ? `<button class="btn-action btn-deliver" onclick="finishOrder()">‚úÖ Commande livr√©e</button>` : ''}
            </div>
            <button class="btn-action btn-cancel" onclick="cancelOrder()">Annuler la course</button>
        </div>
    `;
    document.getElementById('activeOrderContent').innerHTML = html;
}

async function updateOrderStatus(status) {
    if(currentOrderId) {
        await db.collection('orders').doc(currentOrderId).update({status: status});
    }
}

async function finishOrder() {
    if(!currentOrderId || !currentOrderData) return;
    
    const deliveryFee = 5.00; 
    
    await db.collection('orders').doc(currentOrderId).update({
        status: 'delivered',
        deliveredAt: new Date()
    });

    let wallet = parseFloat(localStorage.getItem('alex_wallet') || '0');
    wallet += deliveryFee;
    localStorage.setItem('alex_wallet', wallet.toFixed(2));
    
    updateWalletUI();
    alert(`Livraison termin√©e ! +${deliveryFee}‚Ç¨ cr√©dit√©s.`);
    
    currentOrderId = null;
    openPage('wallet');
}

async function cancelOrder() {
    if(confirm("Annuler cette course ?")) {
        await db.collection('orders').doc(currentOrderId).update({
            status: 'pending',
            courierId: firebase.firestore.FieldValue.delete()
        });
        currentOrderId = null;
        renderOrders();
        closeAllPages();
    }
}

function updateWalletUI() {
    const w = localStorage.getItem('alex_wallet') || '0.00';
    document.getElementById('walletAmount').innerText = w + " ‚Ç¨";
}

function openPage(id) {
    document.querySelectorAll('.full-page').forEach(p => p.style.display = 'none');
    const page = document.getElementById('page-' + id);
    if(page) {
        page.style.display = 'flex';
        if(id === 'settings') initSettingsMap();
    }
}

function closeAllPages() {
    document.querySelectorAll('.full-page').forEach(p => p.style.display = 'none');
}

function initSettingsMap() {
    if(!settingMap) {
        setTimeout(() => {
            settingMap = L.map('settingMap', {zoomControl:false, attributionControl:false}).setView([courierLat, courierLon], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(settingMap);
            L.circle([courierLat, courierLon], {color: '#007bff', fillColor: '#007bff', fillOpacity: 0.2, radius: deliveryRadius * 1000}).addTo(settingMap);
        }, 100);
    }
}

function updateRadius(val) {
    deliveryRadius = val;
    localStorage.setItem('alex_radius', val);
    document.getElementById('distVal').innerText = val;
    renderOrders();
}

function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const res = e.target.result;
            document.getElementById('avatarImg').src = res;
            document.getElementById('avatarImg').style.display = 'block';
            document.getElementById('avatarEmoji').style.display = 'none';
            localStorage.setItem('alex_avatar', res);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function logout() {
    if(confirm("D√©connexion ?")) {
        localStorage.removeItem('alex_courier_logged');
        window.location.href = 'login.html';
    }
}

window.onload = () => { initMap(); };
</script>
</body>
</html> 
